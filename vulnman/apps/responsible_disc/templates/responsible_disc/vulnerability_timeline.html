{% extends 'base.html' %}
{% load markdown %}
{% load guardian_tags %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    {{ vuln.name }}
{% endblock %}


{% block extra_head %}
    <style>
        .timeline-with-icons {
            border-left: 1px solid hsl(0, 0%, 90%);
            position: relative;
            list-style: none;
        }

        .timeline-with-icons .timeline-item {
            position: relative;
        }

        .timeline-with-icons .timeline-item:after {
            position: absolute;
            display: block;
            top: 0;
        }

        .timeline-with-icons .timeline-icon {
            position: absolute;
            left: -48px;
            background-color: hsl(217, 88.2%, 90%);
            color: hsl(217, 88.8%, 35.1%);
            border-radius: 50%;
            height: 31px;
            width: 31px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
{% endblock %}

{% block content %}
    {% get_obj_perms request.user for vuln as "vuln_perms" %}

    <div class="container mt-3">
        <!-- Breadcrumbs -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'responsible_disc:vulnerability-list' %}">Responsible
                    Disclosure</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ vuln.internal_id }}</li>
            </ol>
        </nav>

        {% include 'responsible_disc/components/sub_nav.html' %}

        <div class="row mt-5">
            <div class="col-sm-12 col-md-8 d-flex">
                <div class="justify-content-start">
                    <h3>{{ vuln.template.vulnerability_id }} / {{ vuln.name }}</h3>
                </div>
                <div class="d-block">
                    {% include 'components/severity_badge.html' with obj=vuln %}
                </div>
            </div>
            <div class="col-sm-12 col-md-4 d-flex align-items-end justify-content-end">
                {% if "change_vulnerability" in vuln_perms %}
                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal"
                        data-bs-target="#add-log-item-modal">
                    <i class="fa fa-plus"></i>
                </button>
                {% endif %}
            </div>
        </div>

        <div class="mt-3">
            {% if vuln.status == 0 %}
                <div class="badge bg-success p-2 badge-pill">
                    <i class="fa fa-dot-circle"></i> Open
                </div>
            {% endif %}
            <span class="text-muted">
                by {{ vuln.user.username }} on {{ vuln.date_created|date }}
            </span>
        </div>

        <hr/>
    </div>

    <!-- Timeline -->
    {% include 'responsible_disc/components/timeline.html' with vulnerability=vuln %}

    <div class="modal fade bd-example-modal-lg" id="add-log-item-modal" tabindex="-1" role="dialog"
         aria-labelledby="add-image-proof-modal-label" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <form method="post" action="{% url 'responsible_disc:vulnerability-log-create' vuln.pk %}"
                      enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title" id="add-image-proof-modal-label">Add Log Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        {% crispy log_form %}
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% csrf_token %}
{% endblock %}
