{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}Create Vulnerability{% endblock %}


{% block extra_head %}
    <link href="{% static 'vendor/select2/select2.min.css' %}" rel="stylesheet"/>
    <link href="{% static 'css/vulnman/components/select2.css' %}" rel="stylesheet"/>
    <script src="{% static 'vendor/select2/select2.min.js' %}"></script>
{% endblock extra_head %}


{% block content %}
    <div class="container mt-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                {% include 'core/components/navigation/sidebar-toggler.html' %}
                <li class="breadcrumb-item"><a
                        href="{% url 'projects:findings:vulnerability-list' %}">Vulnerabilities</a></li>
                <li class="breadcrumb-item active" aria-current="page">Create</li>
            </ol>
        </nav>

        {% include 'core/components/forms/in_card.html' with title="Vulnerability" %}
    </div>
{% endblock %}


{% block extra_scripts %}

    <script>
        $('#id_asset_type').change(function () {
            $('#id_f_asset').val("").trigger("change");
            return;
        });
    </script>

    <script>
        $('#id_f_asset').select2({
            theme: 'bootstrap-5',
            ajax: {
                url: function (){
                    let value = $('#id_asset_type option:selected').val();
                    if ( value === "webapplication"){
                        return "{% url 'api:ui:assets:web-application-list' %}";
                    } else if (value === "service"){
                        return "{% url 'api:ui:assets:service-list' %}";
                    } else if (value === "host"){
                        return "{% url 'api:ui:assets:host-list' %}";
                    } else if (value === "thick-client"){
                        return "{% url 'api:ui:assets:thick-client-list' %}";
                    }
                },
                dataType: 'json',
                data: function (params) {
                    // Query parameters will be ?search=[term]&type=public
                    return {search: params.term};
                },
                processResults: function (data) {
                    return {
                        results: jQuery.map(data.results, function (item) {
                            return {
                                id: item.uuid,
                                text: item.display_name
                            }
                        })
                    };
                },
            },
            placeholder: 'Asset',
            minimumInputLength: 1,
        });
        // prefetch initial value
        {% if form.instance %}
            var template_select = $('#id_f_asset');
            var option = new Option("{{ form.instance.asset }}", "{{form.instance.asset.pk}}", true, true);
            template_select.append(option).trigger('change');
        {% endif %}
    </script>


    <script>
        $('#id_template_id').select2({
            theme: 'bootstrap-5',
            ajax: {
                url: '{% url 'api:ui:findings:template-list' %}',
                dataType: 'json',
                data: function (params) {
                    // Query parameters will be ?search=[term]&type=public
                    return {search: params.term};
                },
                processResults: function (data) {
                    return {
                        results: jQuery.map(data.results, function (item) {
                            return {
                                id: item.vulnerability_id,
                                text: item.name
                            }
                        })
                    };
                },
            },
            placeholder: 'Template',
            minimumInputLength: 1,
        });
        // prefetch initial value
        {% if form.instance %}
            var template_select = $('#id_template_id');
            var option = new Option("{{ form.instance.template.name }}", "{{form.instance.template.vulnerability_id}}", true, true);
            template_select.append(option).trigger('change');
        {% endif %}
    </script>
{% endblock %}