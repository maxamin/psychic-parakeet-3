# Generated by Django 4.0.6 on 2022-07-20 14:34

from django.db import migrations, models
import django.db.models.deletion


def migrate_assets(apps, schema_editor):
    Vulnerability = apps.get_model("findings", "Vulnerability")
    ContentType = apps.get_model('contenttypes', 'ContentType')
    for vuln in Vulnerability.objects.all():
        if vuln.asset_host:
            asset = vuln.asset_host
        elif vuln.asset_service:
            asset = vuln.asset_service
        elif vuln.asset_webrequest:
            asset = vuln.asset_webrequest
        else:
            asset = vuln.asset_webapp
        vuln.content_type = ContentType.objects.get_for_model(asset)
        vuln.object_id = asset.pk
        vuln.save()


class Migration(migrations.Migration):

    dependencies = [
        ('contenttypes', '0002_remove_content_type_name'),
        ('findings', '0004_template_description_de_template_description_en_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='vulnerability',
            name='content_type',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, to='contenttypes.contenttype'),
        ),
        migrations.AddField(
            model_name='vulnerability',
            name='object_id',
            field=models.UUIDField(null=True),
        ),
        migrations.RunPython(migrate_assets)
    ]
